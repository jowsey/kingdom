<script lang="ts">
	import { Game, game } from '$lib/game/Game.svelte';
	import { onDestroy } from 'svelte';
	import { blur } from 'svelte/transition';
	import { GenerateDemonym } from '$lib/util/Util';
	import OptionsCategory from '$lib/components/options/OptionsCategory.svelte';
	import StyledInput from '$lib/components/options/StyledInput.svelte';
	import AutoDualColumn from '$lib/components/options/AutoDualColumn.svelte';

	let acceptedDebugModeWarning: boolean = $state(game.Settings.debugMode);

	let cityWordCount = $derived(game.PlayerCity.name.trim().split(' ').length);
	$effect(() => {
		game.Settings.autoDemonymIndex = Math.min(game.Settings.autoDemonymIndex, cityWordCount - 1);
	});

	onDestroy(() => {
		game.PlayerCity.name = game.PlayerCity.name.trim();
		if (game.PlayerCity.name.length === 0) {
			game.PlayerCity.name = Game.Defaults.PlayerCity.name;
		}
	});
</script>

<div class="max-w-lg">
	<p class="mb-8 font-serif text-4xl">Options</p>

	<OptionsCategory title="City">
		<AutoDualColumn>
			<StyledInput
				id="cityName"
				label="Name"
				type="text"
				placeholder={Game.Defaults.PlayerCity.name}
				bind:value={game.PlayerCity.name}
				onfocusout={() => (game.PlayerCity.name = game.PlayerCity.name.trim())}
			/>

			<div class="col-span-full py-2">
				<input bind:checked={game.Settings.autoGenerateDemonym} type="checkbox" id="autoGenerateDemonym" />
				<label for="autoGenerateDemonym">Automatically generate demonym {cityWordCount > 1 ? `(${cityWordCount} choices)` : ''} </label>
			</div>

			{#if game.Settings.autoGenerateDemonym}
				{#if cityWordCount > 1}
					<label for="wordSelect" class="py-2 pr-2">Your people are:</label>
					<select
						id="wordSelect"
						class="rounded-md border border-zinc-500/75 bg-zinc-800/25 px-2 py-1"
						bind:value={game.Settings.autoDemonymIndex}
					>
						{#each game.PlayerCity.name.trim().split(' ') as word, i}
							<option class="bg-zinc-900" value={i}>{GenerateDemonym(word)}</option>
						{/each}
					</select>
				{/if}
			{/if}
		</AutoDualColumn>

		{#if !game.Settings.autoGenerateDemonym}
			<AutoDualColumn>
				<StyledInput
					id="customDemonym"
					label="Custom demonym"
					type="text"
					placeholder={game.PlayerCity.automaticDemonym}
					bind:value={game.Settings.customDemonym}
					onfocusout={() => (game.Settings.customDemonym = game.Settings.customDemonym.trim())}
				/>
			</AutoDualColumn>
		{/if}
	</OptionsCategory>

	<OptionsCategory title="UI features">
		<input bind:checked={game.Settings.enableScrollingText} type="checkbox" id="enableScrollingText" />
		<label for="enableScrollingText">
			Enable the scrolling text bar<br />
			{#if !game.Settings.enableScrollingText}
				<span class="text-xs">I don't blame you.</span>
			{/if}
		</label>
	</OptionsCategory>

	<OptionsCategory title="placeholder"></OptionsCategory>
	<OptionsCategory title="placeholder"></OptionsCategory>
	<OptionsCategory title="placeholder"></OptionsCategory>
	<OptionsCategory title="placeholder"></OptionsCategory>
	<OptionsCategory title="placeholder"></OptionsCategory>

	<OptionsCategory title="Miscellaneous">
		<input
			bind:checked={acceptedDebugModeWarning}
			type="checkbox"
			id="debugModeWarning"
			onchange={(e) => {
				if (!e.currentTarget.checked) {
					game.Settings.debugMode = false;
				}
			}}
		/>
		<label for="debugModeWarning">Enable extras which may be useful for debugging</label>

		{#if acceptedDebugModeWarning}
			<p class="py-2 text-yellow-500">
				This is a bunch of boring behind-the-scenes stuff that will almost certainly ruin the game for you. There are no jokes or secrets
				here.
			</p>
			<input bind:checked={game.Settings.debugMode} type="checkbox" id="enableDebugMode" />
			<label for="enableDebugMode">I understand (enable)</label>
		{/if}
	</OptionsCategory>

	{#if game.Settings.debugMode}
		<div transition:blur>
			<OptionsCategory title="Debug">
				<AutoDualColumn>
					<StyledInput id="debugPeasantPop" label="Peasant pop." type="number" bind:value={game.PlayerCity.people.peasants} />
					<StyledInput id="debugArtisanPop" label="Artisan pop." type="number" bind:value={game.PlayerCity.people.artisans} />
					<StyledInput id="debugMerchantPop" label="Merchant pop." type="number" bind:value={game.PlayerCity.people.merchants} />
					<StyledInput id="debugDaysPerSecond" label="Days per second" type="number" bind:value={game.Settings.daysPerSecond} />
				</AutoDualColumn>
			</OptionsCategory>
		</div>
	{/if}
</div>
